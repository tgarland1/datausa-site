{% extends "templates/nav.html" %}


{% block body %}
<a name="top"></a>
<div class="bound">
  <div id="show-bg">
    <div><i class="fa fa-camera"></i></div>
  </div>

  <article id="splash">
    <div id="splash-image" style="background-image: url('/static/img/splash/geo/04000US46.jpg');"></div>

    <div class="col-sm-4 col-md-4">
    <div class="content">
    <div class="f"></div>

    <div class="splash-titles">

        <div class="row spacer">

        </div>
        <h3>Select a Topic</h3>
     <span> 
     <div class="dropdown">
  <button class="btn btn-default dropdown-toggle" type="button" id="yrbs_topic" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-table-id="">
    Topics
    <span class="caret"></span>
  </button>
  <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
    <li class="dropdown-header">Youth Risky Behaviors - National Level 2015</li>
        <li><a href="#" data-table-id="yrbs2015" value="texted_or_emailed_while_driving">Texted or emailed while driving in the last 30 days</a></li>
        <li><a href="#" data-table-id="yrbs2015" value="currently_smoked_cigarettes">Currently smokes cigarettes</a></li>
        <li><a href="#" data-table-id="yrbs2015" value="currently_used_electronic_vapor_products">Ever used an electronic vapor product</a></li>
        <li><a href="#" data-table-id="yrbs2015" value="were_electronically_bullied">Been electronically bullied in the last 12 months</a></li>
        <li><a href="#" data-table-id="yrbs2015" value="had_sex_with_four_or_more">Had sexual intercourse with four (4) or more people during lifetime</a></li>
        <li><a href="#" value="had_8_or_more_hours_of_sleep">Regularly gets 8 or more hours of sleep</a></li>
    <li role="separator" class="divider"></li>
    <li class="dropdown-header">2014 Mortality</li>
      <li><a href="#" data-table-id="vs2014mort" value="resident_status">Resident Status</a></li>
      <li><a href="#" data-table-id="vs2014mort" value="place_of_death_and_decedents_status">Place Of Death And Decedents Status</a></li>
      <li><a href="#" data-table-id="vs2014mort" value="injury_at_work">Injury At Work</a></li>
      <li><a href="#" data-table-id="vs2014mort" value="manner_of_death">Manner Of Death</a></li>
      <li><a href="#" data-table-id="vs2014mort" value="method_of_disposition">Method Of Disposition</a></li>
      <li><a href="#" data-table-id="vs2014mort" value="activity_code">Activity Code</a></li>
      <li><a href="#" data-table-id="vs2014mort" value="place_of_injury">Place Of Injury</a></li>
      <li><a href="#" data-table-id="vs2014mort" value="cause">Cause</a></li>
      <li role="separator" class="divider"></li>
    <li class="dropdown-header">Youth Risky Behaviors - State Level 2000 - 2013</li>
      <li><a href="#" data-table-id="yrbs2013state" value="sexual_contact">Sexual Contact</a></li>
      <li><a href="#" data-table-id="yrbs2013state" value="texted_or_emailed_while_driving">Texted Or Emailed While Driving</a></li>
      <li><a href="#" data-table-id="yrbs2013state" value="electronically_bullied_in_past_year">Electronically Bullied In Past Year</a></li>
      <li><a href="#" data-table-id="yrbs2013state" value="smoked_in_past_30_days">Smoked In Past 30 Days</a></li>
      <li><a href="#" data-table-id="yrbs2013state" value="had_sex_with_4_or_more_people">Had Sex With 4 Or More People during lifetime</a></li>
      <li><a href="#" data-table-id="yrbs2013state" value="had_8_or_more_hours_of_sleep">Regularly Gets 8 Or More Hours Of Sleep</a></li>


  </ul>
</div>
 <div class="row spacer">

 </div>
 <div id="filter-hdg" style="display: none;"> <h3>Filters</h3> </div>

<div id="yrbs-btns" style="display: none;">

     <div class="row spacer"> </div>

    <button id="age-btn" type="button" class="btn btn-default" data-table-id="yrbs2015">Age &nbsp; <i class="fa fa-caret-down" aria-hidden="true"></i></button>
    <div class="row spacer"> </div>
    <div id="selectages" style="display: none;">
        <p><label><input type="checkbox" id="checkAllAge"/> Select All</label></p>

        <fieldset>
            <p><label><input type="checkbox" id="ageBox" name="age" value="11" checked/> 11</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="age" value="12" checked/> 12</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="age" value="13" checked/> 13</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="age" value="14" checked/> 14</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="age" value="15" checked/> 15</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="age" value="16" checked/> 16</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="age" value="17" checked/> 17</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="age" value="17" checked/> 18</label> &nbsp;
            </p>
        </fieldset>
    </div>
     <div class="row spacer"> </div>

     <button id="gender-btn" type="button" class="btn btn-default" data-table-id="yrbs2015">Gender &nbsp; <i class="fa fa-caret-down" aria-hidden="true"></i></button>
    <div class="row spacer"> </div>
    <div id="selectsex" style="display: none;">
        <p><label><input type="checkbox" id="checkAllGender"/> Both</label></p>

        <fieldset>
            <p><label><input type="checkbox" id="genderBox" name="gender" value="M" checked/> Male</label> &nbsp; <label><input type="checkbox" id="genderBox" name="gender" value="F" checked/> Female</label></p>
        </fieldset>

    </div>
     <div class="row spacer"> </div>

     <button id="race-btn" type="button" class="btn btn-default" data-table-id="yrbs2015">Race / Ethnicity &nbsp; <i class="fa fa-caret-down" aria-hidden="true"></i></button>
    <div class="row spacer"> </div>
    <div id="selectrace" style="display: none;">
        <p><label><input type="checkbox" id="checkAllRace"/> Select All</label></p>

        <fieldset>
            <p><label><input type="checkbox" id="ageBox" name="race" value="white" checked/> White</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="race" value="black" checked/> Black</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="race" value="asian" checked/> Asian</label> &nbsp;
                <label><input type="checkbox" id="ageBox" name="race" value="hispanic" checked/> Hispanic</label> &nbsp;
{#                <label><input type="checkbox" id="ageBox" name="race" value="15" checked/> 15</label> &nbsp;#}
{#                <label><input type="checkbox" id="ageBox" name="race" value="16" checked/> 16</label> &nbsp;#}
{#                <label><input type="checkbox" id="ageBox" name="race" value="17" checked/> 17</label> &nbsp;#}
{#                <label><input type="checkbox" id="ageBox" name="race" value="17" checked/> 18</label> &nbsp;#}
            </p>
        </fieldset>
    </div>

</div>


{#      <select id="selecttest" class="form-control" multiple="multiple" placeholder="Add a filter">#}
{#      <option selected disabled>Select a filter</option>#}
{#      <option class="hidden" data-table-id="yrbs2015" value="sex">Gender</option>#}
{#      <option class="hidden" data-table-id="yrbs2015" value="age">Age</option>#}
{#      <option class="hidden" data-table-id="yrbs2015" value="race_ethnicity">Race / Ethnicity</option>#}
{#      <option class="hidden" data-table-id="yrbs2015" value="grade">Grade</option>#}
{#      <option class="hidden" data-table-id="vs2014mort" value="education_2003_revision">Education</option>#}
{#      <option class="hidden" data-table-id="vs2014mort" value="month_of_death">Month of Death</option>#}
{#      <option class="hidden" data-table-id="vs2014mort" value="sex">Gender</option>#}
{#      <option class="hidden" data-table-id="vs2014mort" value="age">Age</option>#}
{#      <option class="hidden" data-table-id="vs2014mort" value="day_of_week_of_death">Day Of Week Of Death</option>#}
{#      <option class="hidden" data-table-id="vs2014mort" value="autopsy">Autopsy</option>#}
{#      <option class="hidden" data-table-id="vs2014mort" value="race_ethnicity">Race / Ethnicity</option>#}
{#      <option class="hidden" data-table-id="vs2014mort" value="marital_status">Marital Status</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="state">State</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="year">Year</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="age">Age</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="sex">Gender</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="grade">Grade</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="race_breakdown_seven">Race Breakdown Seven</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="sexual_identity">Sexual Identity</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="obesity_indicator">Obesity Indicator</option>#}
{#      <option class="hidden" data-table-id="yrbs2013state" value="overweight_indicator">Overweight Indicator</option>#}
{#    </select>#}
    <div class="hidden issex">Gender <a href="#" class="remove" rel="sex" style="color: grey">remove</a></div>
    <div class="hidden isage">Age <a href="#" class="remove" rel="age" style="color: grey">remove</a></div>
    <div class="hidden israce_ethnicity">Race / Ethnicity <a href="#" class="remove" rel="race_ethnicity" style="color: grey">remove</a></div>
    <div class="hidden isgrade">Grade <a href="#" class="remove" rel="grade" style="color: grey">remove</a></div>
    <div class="hidden iseducation_2003_revision">Education <a href="#" class="remove" rel="education_2003_revision" style="color: grey">remove</a></div>
    <div class="hidden ismonth_of_death">Month of Death <a href="#" class="remove" rel="month_of_death" style="color: grey">remove</a></div>
    <div class="hidden isday_of_week_of_death">Day of Week of Death <a href="#" class="remove" rel="day_of_week_of_death" style="color: grey">remove</a></div>
    <div class="hidden isautopsy">Autopsy <a href="#" class="remove" rel="autopsy" style="color: grey">remove</a></div>
    <div class="hidden ismarital_status">Marital Status <a href="#" class="remove" rel="marital_status" style="color: grey">remove</a></div>
    <div class="hidden isstate">State <a href="#" class="remove" rel="state" style="color: grey">remove</a></div>
    <div class="hidden isyear">Year <a href="#" class="remove" rel="year" style="color: grey">remove</a></div>
    <div class="hidden israce_breakdown_seven">Race / Ethnicity <a href="#" class="remove" rel="race_breakdown_seven" style="color: grey">remove</a></div>
    <div class="hidden issexual_identity">Sexual Identity <a href="#" class="remove" rel="sexual_identity" style="color: grey">remove</a></div>
    <div class="hidden isobesity_indicator">Obsese <a href="#" class="remove" rel="obesity_indicator" style="color: grey">remove</a></div>
    <div class="hidden isoverweight_indicator">Overweight <a href="#" class="remove" rel="overweight_indicator" style="color: grey">remove</a></div>

     <br>
    <button type="button" id="yrbsExecuteQuery" data-loading-text="Loading..." class="btn btn-primary" autocomplete="off">
      Execute Query
    </button>
    </span>

    </div>
    </div>
    </div>

    <div class="col-sm-8 col-md-8">
    <div class="content">
      <div class="f"></div>

      <div class="splash-titles">
      <h1>Health Data Analysis</h1>
      <div id="test_viz2"></div>

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
      </div>
      </div>
        </div>

      </article>
{% endblock %}

{% block js %}

<script>

var idorder = [];


//need to create a function that will remove items from idorder when "remove" is clicked
$("#selecttest").change(function(){
    var value = $("#selecttest option:selected").val();
    var theDiv = $(".is" + value);
    idorder.push(value);
    {#    alert(idorder[0]);#}
    theDiv.slideDown().removeClass("hidden");
    $("#selecttest option:selected").attr('disabled','disabled');
});

$("div a.remove").click(function () {
    var value = $(this).attr('rel');
    var theDiv = $(".is" + value);
    $("#selecttest option[value=" + value + "]").removeAttr('disabled');
    $(this).parent().slideUp(function() { $(this).addClass("hidden"); });
    var index = idorder.indexOf(value);
    if (index > -1) {
        idorder.splice(index, 1);
    }
});

// YRBS jQuery

$("#age-btn").click(function () {
    $("#selectages").toggle();
    $("input[name=age]").prop('checked', 'checked');
});

$("#checkAllAge").change(function () {
    $("input[name=age]").prop('checked', $(this).prop("checked"));
});

$("#gender-btn").click(function () {
    $("#selectsex").toggle();
    $("input[name=gender]").prop('checked', 'checked');
});

$("#checkAllGender").change(function () {
    $("input[name=gender]").prop('checked', $(this).prop("checked"));
});

$("#race-btn").click(function () {
    $("#selectrace").toggle();
});

$("#checkAllRace").change(function () {
    $("input[name=race]").prop('checked', $(this).prop("checked"));
});


//this function allows the topic dropdown text to change after the selection, which will drive the API url development
$(function(){
    $(".dropdown-menu li a").click(function(){
      //this line below clears all of the options from a previously selected topic
      $("option[data-table-id]").addClass("hidden");
      $(this).parent().parent().siblings(".btn").text($(this).text());
      $(this).parent().parent().siblings(".btn").attr("value",$(this).attr("value"));
      $(this).parent().parent().siblings(".btn").data("table-id",$(this).data("table-id"));
      var table_id = $(this).data("table-id");
      $("option[data-table-id="+table_id+"]").removeClass("hidden");
      $("#filter-hdg").show();
      if ( table_id == 'yrbs2015' ){
            $("#yrbs-btns").show();
      }
      else {
            $("#yrbs-btns").hide();
      }
{#      if ( $("button[data-table-id="+table_id+"]").css('display') == 'none' ){#}
{#            $("button[data-table-id="+table_id+"]").show();#}
{#      }#}

      //need to empty the idorder array if another topic is chosen, and clear the display of hidden options
      idorder = [];
      $("[class^=is]").addClass("hidden");
   });

});

//the function below will run when the query button is pushed
$('#yrbsExecuteQuery').on('click', function () {
    $( "#test_viz2" ).empty();
    var $btn = $(this);
    $btn.button('loading');
    // business logic...
    //pick the right API endpoint based on the topic selection
    if($("#yrbs_topic").data("table-id") == "yrbs2015"){
    var api = "http://ec2-52-90-94-195.compute-1.amazonaws.com/query/owhyrbsquery?";
    }
    if($("#yrbs_topic").data("table-id") == "vs2014mort"){
    var api = "http://ec2-52-90-94-195.compute-1.amazonaws.com/query/owhmortalityquery?";
    }
    if($("#yrbs_topic").data("table-id") == "yrbs2013state"){
    var api = "http://ec2-52-90-94-195.compute-1.amazonaws.com/query/owhyrbs2013query?";
    }
    //build the api string
    var x = idorder.length;
    if (x > 0) {
        for (i = 0; i < x; i++) {
            api = api.concat("&column=",idorder[i],"&group=",idorder[i])
        }
        api = api.concat('&column=',$("#yrbs_topic").attr("value"))
    }
    //set the topic, which will get passed into the viz constructor
    var topic = $("#yrbs_topic").attr("value");
    console.log(api);
    //now the the query is formed, we need to make an ajax call to get the data:
    d3.json(api, function(data){
        //send the data to the makeviz function to render the viz
        datasetr=data;
        dynamicviz(datasetr.data, idorder, topic);
    });
    $btn.button('reset');
    // idorder = idorder
  });

{#  Smoking Data #}

function dynamicviz(data, idorder, topic) {
    //sort the data
    //console.log(data)
    data = data.filter(function (n) {
        return n.count != 0;
    });
    data.sort(function (a, b) {
        if (a.count > b.count) {
            return 1;
        }
        if (a.count < b.count) {
            return -1;
        }
    });
    var yaxislable;
    //the if function below will just rename all of the "count" keys in the json object to "percentage" for display purposes
    if ($("#yrbs_topic").data("table-id") == "yrbs2013state" || $("#yrbs_topic").data("table-id") == "yrbs2015"){
        data.map(function(arrayitem){
          arrayitem['percentage'] = arrayitem['count'];
          delete arrayitem['count'];
        });
        yaxislable = "percentage";
    }
    else{
      yaxislable = "count";
    }
    //render the viz
    var visualization = d3plus.viz()
            .container("#test_viz2") //note I purposefully broke this call
            .data(data)
            .type("bar")
            .id(idorder)
            .x(topic)
            .y(yaxislable)
            .draw();
};


  var fontRange = [50, 65];
  if (window.innerWidth <= 480) {
    fontRange = [45, 60];
  }

  var fontScale = d3.scale.linear()
    .domain([60, 20])
    .range(fontRange)
    .clamp(true);

  var title = d3.select(".splash-titles h1");
  title.style("font-size", fontScale(title.text().length) + "px");

  if (!d3plus.client.touch) {
    var scrollTimeout = setTimeout(function(){
      d3.select("#scroll-btn").classed("visible", true);
    }, 5000);
  }

  var maxCarousel = d3.selectAll(".carousel-text").size() - 1, currentPage = 0;
  d3.selectAll(".carousel-btn").on("click", function(d, i){
    if (i && currentPage < maxCarousel) currentPage++;
    else if (i === 0 && currentPage > 0) currentPage--;

    d3.select("#carousel-page").text(currentPage + 1);

    d3.selectAll(".carousel-btn").classed("active", function(dd, ii){
      return !ii && currentPage || ii && currentPage < maxCarousel;
    });
    d3.selectAll(".carousel-text").classed("active", function(dd, ii){
      return ii === currentPage;
    });
  });

  d3.select(".expand-stats-btn").on("click", function(){
    d3.event.preventDefault();
    d3.select(this).classed("close", !d3.select(this).classed("close"));
    d3.select("#nav-bar-scroll").classed("stat-hidden", !d3.select("#nav-bar-scroll").classed("stat-hidden"));
  });

  var splashHeight = d3.select("#splash").node().offsetHeight,
      boundHeight = d3.select(".bound").node().offsetHeight
      titleNavHeight = d3.select("#title-bar").node().offsetHeight,
      statNavHeight = d3.select("#stats-bar").node().offsetHeight,
      profNavHeight = d3.select("#profile-nav").node().offsetHeight,
      footerTop = d3.select(".profile-end").node().offsetTop;

  var sideButtons = d3.selectAll(".section-sidenav-button"), sideNavBottom = 0;
  if (sideButtons.size()) {
    sideNavBottom = sideButtons[0][sideButtons.length - 1].offsetTop + 30;
  }


  var firstScroll = true;

  function navScroll(){

    if (!firstScroll) {
      clearTimeout(scrollTimeout);
      d3.select("#scroll-btn").classed("visible", false);
    }
    firstScroll = false;

    var y = d3plus.client.scroll.y(),
        colorTitleNav = y > titleNavHeight,
        showTitleNav = y > splashHeight/2.75,
        showStatNav = y > splashHeight,
        showProfNav = y > (boundHeight - titleNavHeight - statNavHeight) &&
                      (y + sideNavBottom) < footerTop;

    var parallaxScroll = d3.scale.linear()
      .domain([0, window.innerHeight])
      .rangeRound([0, window.innerHeight/3.6])
      .clamp(true);

    d3.select("#splash-image").style("top", parallaxScroll(y) + "px")

    d3.select("#top-nav").classed("filled", colorTitleNav);
    d3.select("nav").classed("filled", colorTitleNav);
    d3.select("#title-bar").classed("visible", showTitleNav);
    d3.select("#home-btn").classed("hidden", showTitleNav);

    d3.select("#stats-bar").classed("visible", showProfNav);
    d3.select(".expand-stats-btn").classed("show", showProfNav);
    d3.select("#profile-nav").classed("visible", showProfNav);
    d3.select("#section-sidenav").classed("visible", showProfNav);

    var active_section;
    var top_buffer = titleNavHeight + profNavHeight + statNavHeight + 15;
    d3.selectAll("header a[name]")
      .each(function(){
        var top = this.parentNode.parentNode.offsetTop;
        if (top - top_buffer < y) {
          active_section = this.name;
        }
      })
    d3.selectAll("#profile-nav li")
      .classed("active", function(){
        return this.getAttribute("data-anchor") === active_section;
      });

    var active_sub;
    var subs = d3.selectAll("section." + active_section + " .category a[name]");
    if (subs.size()) {
      subs.each(function(){
          var top = this.parentNode.offsetTop;
          if (top - top_buffer < y) {
            active_sub = this.name;
          }
        });
    }
    else {
      active_sub = active_section;
    }
    d3.selectAll(".section-sidenav-button")
      .classed("active", function(){
        return this.getAttribute("data-anchor") === active_sub;
      })

  }

  navScroll();
  scrollFunctions.push(navScroll);

  d3.select("#show-bg").on("click", function(){
    var show = d3.select("#splash-image").classed("color");
    d3.select("#splash-image").classed("color", !show);
    d3.select("#splash .content").classed("hide", !show);
  });

  // toggle extra items in long list
  d3.selectAll(".show-more").on("click", function(){
    d3.event.preventDefault();
    d3.select(this).style("display", "none");
    d3.select(this.parentNode.nextSibling).style("display", "inline");
  })

</script>

{% endblock %}
