<!doctype html>
<html>

  <head>
    <title>D3plus</title>
    <!-- loading D3plus JS file -->

    <!-- <script src="./jquery-3.1.0.min.js"></script> -->

    <script src="./jquery-2.2.2.min.js"></script>

    <script src="./data/mortality.js"></script>
    <script src="https://d3plus.org/js/d3plus.full.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  </head>

  <body>


    <div id="mortalityCharts"></div>
  </body>

  <script>

    //currentState can be set to null
    //  it only changes the text of the [currentState] within the tree-map
    var createMortalityCharts = function(containerName,currentState){

      //We create a dropdown under "parentName" and return the newly added object to reference later
      var createDropdown = function(myOptions,parentName,section){
        var parent = $('#'+parentName);
        parent.append('<label for="'+parentName+'_'+section+'_selector">'+section+'</select>')
        parent.append('<select id="'+parentName+'_'+section+'_selector"></select>')

        var mySelect = $('#'+parentName+'_' +section+'_selector');

        $.each(myOptions, function(optionIndex, optionObject) {
            mySelect.append(
                $('<option></option>').val(optionObject.value).html(optionObject.value)
            );
        });
        return mySelect;
      }
      //Filter used onChange for each of the dropdowns
      //Returns new array of filtered data
      var filter = function(data, myFilters){
        var new_arr = [];
        $.each(data, function(dataIndex, dataRow) {
          var include = true;
          $.each(myFilters, function(filterIndex, filterRow) {
            if(dataRow[filterRow.columnName] != filterRow.value)
              include = false;
          });
          if(include)
            new_arr.push(dataRow);
        });
        return new_arr;
      };

        //List of Sections and their filters
        var sections = ["sex","age","cause","race","state_name"];

        //Creates selectable items found in dropdowns per each section
        var myFilters = {age : [
          {columnName:'age',value:"None"},
          {columnName:"age",value:"1 month - 11 months (includes not stated months)"},
          {columnName:"age",value:"1 year"},
          {columnName:"age",value:"10 - 14 years"},
          {columnName:"age",value:"100 years and over"},
          {columnName:"age",value:"15 - 19 years"},
          {columnName:"age",value:"2 years"},
          {columnName:"age",value:"20 - 24 years"},
          {columnName:"age",value:"25 - 29 years"},
          {columnName:"age",value:"3 years"},
          {columnName:"age",value:"30 - 34 years"},
          {columnName:"age",value:"35 - 39 years"},
          {columnName:"age",value:"4 years"},
          {columnName:"age",value:"40 - 44 years"},
          {columnName:"age",value:"45 - 49 years"},
          {columnName:"age",value:"5 - 9 years"},
          {columnName:"age",value:"50 - 54 years"},
          {columnName:"age",value:"55 - 59 years"},
          {columnName:"age",value:"60 - 64 years"},
          {columnName:"age",value:"65 - 69 years"},
          {columnName:"age",value:"70 - 74 years"},
          {columnName:"age",value:"75 - 79 years"},
          {columnName:"age",value:"80 - 84 years"},
          {columnName:"age",value:"85 - 89 years"},
          {columnName:"age",value:"90 - 94 years"},
          {columnName:"age",value:"95 - 99 years"}
        ], cause : [
          {columnName:'cause',value:"None"},
          // {columnName:'cause',value:"Tuberculosis"},
          // {columnName:'cause',value:"Hypertensive heart disease with or without renal disease"},
          // {columnName:'cause',value:"Non-Hodgkin's lymphoma"},
          // {columnName:'cause',value:"Syphilis"},
          // {columnName:'cause',value:"Malignant neoplasms of colon, rectum and anus"},
          // {columnName:'cause',value:"Intentional self-harm (suicide)"},
          // {columnName:'cause',value:"Nephritis, nephrotic syndrome, and nephrosis"},
          // {columnName:'cause',value:"Malignant neoplasm of breast"},
          // {columnName:'cause',value:"Peptic ulcer"},
          // {columnName:'cause',value:"Pregnancy, childbirth and the puerperium"},
          // {columnName:'cause',value:"Sudden infant death syndrome"},
          // {columnName:'cause',value:"Other diseases of circulatory system"},
          // {columnName:'cause',value:"Chronic liver disease and cirrhosis"},
          // {columnName:'cause',value:"Malignant neoplasms of cervix uteri, corpus uteri and ovary"},
          // {columnName:'cause',value:"Diabetes mellitus"},
          // {columnName:'cause',value:"Atherosclerosis"},
          // {columnName:'cause',value:"Leukemia"},
          // {columnName:'cause',value:"Malignant neoplasm of prostate"},
          // {columnName:'cause',value:"Assault (homicide)"},
          // {columnName:'cause',value:"Malignant neoplasm of pancreas"},
          // {columnName:'cause',value:"Motor vehicle accidents"},
          // {columnName:'cause',value:"Chronic lower respiratory diseases"},
          // {columnName:'cause',value:"All other external causes"},
          // {columnName:'cause',value:"All other and unspecified accidents and adverse effects"},
          // {columnName:'cause',value:"Alzheimer's disease"},
          // {columnName:'cause',value:"Influenza and pneumonia"},
          // {columnName:'cause',value:"Human immunodeficiency virus (HIV) disease"},
          // {columnName:'cause',value:"Malignant neoplasms of urinary tract"},
          // {columnName:'cause',value:"Essential (primary) hypertension and hypertensive renal disease"},
          // {columnName:'cause',value:"Malignant neoplasm of stomach"},
          // {columnName:'cause',value:"Cerebrovascular diseases"},
          // {columnName:'cause',value:"Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified (excluding Sudden infant death syndrome)"},
          // {columnName:'cause',value:"Certain conditions originating in the perinatal period"},
          // {columnName:'cause',value:"Congenital malformations, deformations and chromosomal abnormalities"}
          {columnName:'cause',value:"All other diseases (Residual)"},
          {columnName:'cause',value:"Ischemic heart diseases"},
          {columnName:'cause',value:"Malignant neoplasms of trachea, bronchus and lung"},
          {columnName:'cause',value:"Other diseases of heart"},
          {columnName:'cause',value:"Other malignant neoplasms"},
        ], sex : [
          {columnName:'sex',value:"None"},
          {columnName:'sex',value:"Male"},
          {columnName:'sex',value:"Female"}
        ], race : [
          {columnName:'sex',value:"None"},
          {columnName:'sex',value:"Black"},
          {columnName:'sex',value:"American Indian (includes Aleuts and Eskimos)"},
          {columnName:'sex',value:"Chinese"},
          {columnName:'sex',value:"Filipino"},
          {columnName:'sex',value:"White"}
        ]
      };

      $.each(sections, function(index, section) {
        //create an id
        var myContainerName = 'mortality_'+section;

        //graphic container is split into two sections, one for the filter and the other for the graph
        var filterContainerName = myContainerName+'_filters';
        var graphContainerName = myContainerName+'_graph';

        //Set the title for the chart
        $('#'+containerName).append('<h2 class="embed-title"><a href="#mortality" name="income_gender">Mortality</a> <a href="#mortality" class="btn pri-btn data-btn" data-target-id="null" data-embed="/null" data-url="null" id="DeloitteCustomButton"><span>Options</span></a></h2>');
        //Add an options button
        $('#'+containerName).append('<div id="'+myContainerName+'"><div id="'+filterContainerName+'"></div><br/><div id="'+graphContainerName+'"></div></div>');

        //we add the graph to the graph container
        var myScatter;
        if(section!='state_name'){
          myScatter = d3plus.viz()
                  .container('#'+graphContainerName)
                  .type("bar")
                  .data(mortalityData)
                  .id(section)
                  .x(section)
                  .y("count")
                  .color(section)
                  .height(400)
                  .width(800)
                  .draw()
        }else{
          //Creates a treemap
          myScatter = d3plus.viz()
            .container('#'+graphContainerName)  // container DIV to hold the visualization
            .data(mortalityData)  // data to use with the visualization
            .type("tree_map")   // visualization type
            .id("state_name")         // key for which our data is unique on
            .size("count")      // sizing of blocks
            .height(400)
            .width(800)
            .text(function(a,b,c,d){
              if(a.d3plus_label && a.d3plus_label.names){
                // a.d3plus_label.names[0]=a.value + "% \n stdv(" +a.sderror+ ") \n ci("+a['ci-low']+"-"+a['ci-high']+")";
                return null;//it will output the id as the header within the hover menu with this null
              }
              return a.state_name + (a.state_name==currentState?"*":"");
            })
            .draw()             // finally, draw the visualization!
        }

        var myFilter = [];

        //dropdown creation
        //We create multiple filters per each graph, all named after the sections [age,race,gender]
        $.each(sections, function(index, sectionTwo) {
          if(section != sectionTwo && sectionTwo!='state_name'){
            var myDropdown = createDropdown(myFilters[sectionTwo],filterContainerName,sectionTwo);
            myDropdown.change(function(){
              //value of dropdown
              var b = myDropdown.val();

              //remove previous filters for this sectionTwo (only one age filter allowed at once)
              var removeIndex = -1
              $.each(myFilter, function(filterIndex, filterRow) {
                if(filterRow.columnName == sectionTwo)
                  removeIndex = filterIndex;
              });
              //if we found a filter on this category already then we remove it
              if(removeIndex >= 0)
                myFilter.splice(removeIndex,1);

              //add the new filter
              if(b != "None")
              myFilter.push({"columnName":sectionTwo,"value":b});
              //filter the data and populate the graph
              myScatter.data(filter(mortalityData, myFilter)).draw();
            });
          }
        });// end of dropdown creation
      });//end of section loop
    }//end of create charts



    //Create Mortality charts within specified container id
    createMortalityCharts('mortalityCharts','California');
  </script>

</html>
